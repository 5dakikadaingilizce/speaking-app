<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grammar-Aware Speaking Drill</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#141e30,#243b55);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}
.app{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  padding:30px;
  border-radius:18px;
  width:95%;
  max-width:700px;
  text-align:center;
}
#phrase{
  font-size:28px;
  font-weight:600;
  margin:25px 0;
}
button{
  padding:12px 18px;
  margin:6px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
}
.start{background:#00c6ff;color:white;}
.ctrl{background:#444;color:white;}
.next{background:#00ffb3;color:black;display:none;}
.correct{color:#00ffb3;font-size:22px;}
.wrong{color:#ff6b6b;font-size:22px;}
.stats{margin-top:15px;font-size:14px;}
</style>
</head>

<body>

<div class="app">
<h2>üé§ Speaking Drill (Grammar Aware)</h2>

<div id="phrase"></div>

<button class="start" id="startBtn">‚ñ∂ Start</button><br>
<button class="ctrl" id="listenBtn">üîä Listen</button>
<button class="ctrl" id="backBtn">‚¨Ö Back</button>
<button class="next" id="nextBtn">Next ‚ñ∂</button>

<div id="result"></div>

<div class="stats">
Phrase <span id="current"></span>/<span id="total"></span><br>
‚úÖ <span id="correct">0</span> |
‚ùå <span id="wrong">0</span>
</div>
</div>

<audio id="okSound" src="https://actions.google.com/sounds/v1/ui/positive_confirmation.ogg"></audio>
<audio id="badSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
// ================= PREPOSITIONS =================
const prepositions = [
  "of","to","for","from","with","without",
  "after","before","about","because of","in","on","at"
];

// ================= DETERMINERS =================
const determiners = [
  { type:"article", value:"a" },
  { type:"article", value:"an" },
  { type:"definite", value:"the" },
  { type:"possessive", value:"my" },
  { type:"possessive", value:"your" },
  { type:"number", value:2 },
  { type:"number", value:3 },
  { type:"number", value:4 }
];

// ================= NOUNS (EXTENDABLE) =================
const nouns = [
  { word:"child", countable:true, plural:false },
  { word:"children", countable:true, plural:true }
];

// ================= GRAMMAR ENGINE =================
function isValidCombination(det, noun){
  if(det.type==="article"){
    if(!noun.countable) return false;
    if(noun.plural) return false;
    if(det.value==="an" && !/^[aeiou]/i.test(noun.word)) return false;
    if(det.value==="a" && /^[aeiou]/i.test(noun.word)) return false;
  }
  if(det.type==="number"){
    if(!noun.countable) return false;
    if(noun.plural===false) return false;
  }
  return true;
}

// ================= BUILD PHRASES =================
let phrases = [];
prepositions.forEach(p=>{
  determiners.forEach(d=>{
    nouns.forEach(n=>{
      if(isValidCombination(d,n)){
        phrases.push(`${p} ${d.value} ${n.word}`);
      }
    });
  });
});

// ================= STATE =================
let index=0;
let correctCount=0;
let wrongCount=0;
let solved=new Array(phrases.length).fill(false);

// ================= ELEMENTS =================
const phraseEl=document.getElementById("phrase");
const resultEl=document.getElementById("result");
const nextBtn=document.getElementById("nextBtn");
const okSound=document.getElementById("okSound");
const badSound=document.getElementById("badSound");

document.getElementById("total").textContent=phrases.length;

function render(){
  phraseEl.textContent=phrases[index];
  document.getElementById("current").textContent=index+1;
  document.getElementById("correct").textContent=correctCount;
  document.getElementById("wrong").textContent=wrongCount;
  nextBtn.style.display=solved[index]?"inline-block":"none";
}
render();

// ================= US VOICE =================
let usVoice=null;
speechSynthesis.onvoiceschanged=()=>{
  const v=speechSynthesis.getVoices();
  usVoice=v.find(x=>x.lang==="en-US")||v[0];
};

function speak(){
  const u=new SpeechSynthesisUtterance(phrases[index]);
  u.lang="en-US";
  u.rate=0.9;
  if(usVoice)u.voice=usVoice;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// ================= SPEECH RECOGNITION =================
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
const rec=new SR();
rec.lang="en-US";

function normalize(t){
  return t.toLowerCase().replace(/[^\w\s]/g,"").trim();
}

rec.onresult=e=>{
  const spoken=normalize(e.results[0][0].transcript);
  const target=normalize(phrases[index]);

  if(spoken===target){
    if(!solved[index]){
      solved[index]=true;
      correctCount++;
    }
    resultEl.innerHTML='<div class="correct">‚úÖ CORRECT</div>';
    okSound.currentTime=0; okSound.play();
  }else{
    wrongCount++;
    resultEl.innerHTML='<div class="wrong">‚ùå TRY AGAIN</div>';
    badSound.currentTime=0; badSound.play();
  }
  render();
};

// ================= BUTTONS =================
document.getElementById("startBtn").onclick=()=>{
  rec.start();
};
document.getElementById("listenBtn").onclick=speak;
document.getElementById("nextBtn").onclick=()=>{
  if(solved[index] && index<phrases.length-1){
    index++;
    resultEl.innerHTML="";
    render();
    speak();
  }
};
document.getElementById("backBtn").onclick=()=>{
  if(index>0 && solved[index-1]){
    index--;
    resultEl.innerHTML="";
    render();
    speak();
  }
};
</script>

</body>
</html>
