<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grammar-Aware Speaking Drill - Vers.1.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#141e30,#243b55);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}
.app{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(12px);
  padding:30px;
  border-radius:18px;
  width:95%;
  max-width:600px;
  text-align:center;
  position: relative;
}
.version-tag {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 11px;
  opacity: 0.5;
}
#phrase{
  font-size:30px;
  font-weight:700;
  margin:20px 0;
  color: #00ffb3;
  text-shadow: 0 0 10px rgba(0,255,179,0.3);
}
button{
  padding:14px 20px;
  margin:6px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
  font-weight: bold;
  transition: 0.2s;
}
button:active { transform: scale(0.95); }
.start{background:#00c6ff;color:white;}
.ctrl{background:#444;color:white;}
.next{background:#00ffb3;color:black; display:none;}
.correct{color:#00ffb3;font-size:24px; font-weight:bold;}
.wrong{color:#ff6b6b;font-size:24px; font-weight:bold;}
.stats{margin-top:20px;font-size:14px; opacity: 0.8; line-height: 1.6;}
</style>
</head>

<body>

<div class="app">
  <div class="version-tag">Vers.1.1</div>
  <h2>üé§ Speaking Practice</h2>
  <div id="phrase">Loading phrases...</div>

  <button class="start" id="startBtn">üé§ START SPEAKING</button><br>
  <button class="ctrl" id="listenBtn">üîä Listen Word</button>
  <button class="ctrl" id="backBtn">‚¨Ö Back</button>
  <button class="next" id="nextBtn">Next ‚ñ∂</button>

  <div id="result"></div>

  <div class="stats">
    Phrase <span id="current"></span> / <span id="total"></span><br>
    ‚úÖ <span id="correct">0</span> | ‚ùå <span id="wrong">0</span>
  </div>
</div>

<audio id="okSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
<audio id="badSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>

<script>
/* VERSION: 1.1
   CHANGES: 
   - Speed increased (1.1x)
   - AudioContext unlock added
   - Grammar engine fixed (no more 'a children')
   - Version tag added to UI
*/

// ================= GRAMMAR ENGINE =================
const prepositions = ["of","to","for","from","with","in","on","at"];
const determiners = [
  { type:"article", value:"a" },
  { type:"article", value:"an" },
  { type:"number", value:"two" },
  { type:"number", value:"three" },
  { type:"possessive", value:"my" }
];
const nouns = [
  { word:"child", plural:false, vowel:false },
  { word:"children", plural:true, vowel:false },
  { word:"apple", plural:false, vowel:true },
  { word:"apples", plural:true, vowel:true },
  { word:"car", plural:false, vowel:false },
  { word:"cars", plural:true, vowel:false }
];

function isValid(det, noun) {
  if (det.type === "article" && noun.plural) return false;
  if (det.value === "an" && !noun.vowel) return false;
  if (det.value === "a" && noun.vowel) return false;
  if (det.type === "number" && !noun.plural) return false;
  return true;
}

let phrases = [];
prepositions.forEach(p => {
  determiners.forEach(d => {
    nouns.forEach(n => {
      if(isValid(d, n)) phrases.push(`${p} ${d.value} ${n.word}`);
    });
  });
});

// ================= STATE =================
let index = 0;
let correctCount = 0;
let wrongCount = 0;
let solved = new Array(phrases.length).fill(false);

const phraseEl = document.getElementById("phrase");
const resultEl = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");
const okSound = document.getElementById("okSound");
const badSound = document.getElementById("badSound");

document.getElementById("total").textContent = phrases.length;

function render() {
  phraseEl.textContent = phrases[index];
  document.getElementById("current").textContent = index + 1;
  document.getElementById("correct").textContent = correctCount;
  document.getElementById("wrong").textContent = wrongCount;
  nextBtn.style.display = solved[index] ? "inline-block" : "none";
}
render();

// ================= SPEAKING (FAST) =================
function speak() {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(phrases[index]);
  u.lang = "en-US";
  u.rate = 1.1; // Hƒ±zlƒ± ve akƒ±cƒ±
  window.speechSynthesis.speak(u);
}

// ================= RECOGNITION =================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();
rec.lang = "en-US";
rec.continuous = false;

rec.onstart = () => {
    document.getElementById("startBtn").innerText = "Listening...";
    document.getElementById("startBtn").style.background = "#ff4b2b";
};

rec.onresult = e => {
  const spoken = e.results[0][0].transcript.toLowerCase().replace(/[^\w\s]/g,"").trim();
  const target = phrases[index].toLowerCase().trim();

  if(spoken === target) {
    if(!solved[index]) { solved[index] = true; correctCount++; }
    resultEl.innerHTML = '<div class="correct">‚úÖ PERFECT!</div>';
    okSound.play(); 
  } else {
    wrongCount++;
    resultEl.innerHTML = `<div class="wrong">‚ùå You said: "${spoken}"</div>`;
    badSound.play();
  }
  render();
};

rec.onend = () => {
    document.getElementById("startBtn").innerText = "üé§ START SPEAKING";
    document.getElementById("startBtn").style.background = "#00c6ff";
};

// ================= BUTTON ACTIONS =================
document.getElementById("startBtn").onclick = () => {
    // Tarayƒ±cƒ±yƒ± ses √ßalmak i√ßin zorla (Unlock)
    okSound.play().then(() => { okSound.pause(); okSound.currentTime = 0; });
    rec.start();
};

document.getElementById("listenBtn").onclick = speak;

document.getElementById("nextBtn").onclick = () => {
    if(index < phrases.length - 1) {
      index++; 
      resultEl.innerHTML = ""; 
      render(); 
      speak();
    }
};

document.getElementById("backBtn").onclick = () => {
    if(index > 0) { 
      index--; 
      resultEl.innerHTML = ""; 
      render(); 
      speak(); 
    }
};
</script>

</body>
</html>
