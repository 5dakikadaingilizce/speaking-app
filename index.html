<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Speaking Drill Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.app {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  padding: 32px;
  border-radius: 18px;
  width: 90%;
  max-width: 520px;
  text-align: center;
  color: white;
}

#phrase {
  font-size: 28px;
  margin: 24px 0;
  font-weight: 600;
}

button {
  padding: 12px 18px;
  margin: 6px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
}

.start { background:#00c6ff; color:#fff; }
.ctrl { background:#444; color:#fff; }

.correct { 
  color:#00ffb3; 
  font-size:22px;
  margin-top:10px;
}

.wrong { 
  color:#ff6b6b; 
  font-size:22px;
  margin-top:10px;
}

.stats {
  margin-top: 18px;
  font-size: 14px;
}
</style>
</head>

<body>

<div class="app">

<h2>üé§ Speaking Drill</h2>

<div id="phrase"></div>

<button class="start" onclick="initApp()">‚ñ∂ Start Session</button><br>
<button class="ctrl" onclick="speak()">üîä Listen</button>
<button class="ctrl" onclick="back()">‚¨Ö Back</button>
<button class="ctrl" onclick="skip()">Skip ‚û°</button>

<div id="result"></div>

<div class="stats">
Phrase <span id="current"></span>/<span id="total"></span><br>
‚úÖ <span id="correct">0</span> |
‚ùå <span id="wrong">0</span>
</div>

</div>

<audio id="ok" src="https://actions.google.com/sounds/v1/ui/positive_confirmation.ogg"></audio>
<audio id="bad" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
// ================= DATA =================
const preps = ["of","to","for","from","with","without","after","before","about","because of"];
const dets = ["the","my","your","two","three","four"];
const noun = "children";

let phrases = [];
preps.forEach(p=>dets.forEach(d=>phrases.push(`${p} ${d} ${noun}`)));

let i = 0, ok = 0, bad = 0;
let initialized = false;
let femaleVoice = null;

// ================= UI =================
const phraseEl = document.getElementById("phrase");
const resultEl = document.getElementById("result");
const okSound = document.getElementById("ok");
const badSound = document.getElementById("bad");

okSound.volume = 0.7;
badSound.volume = 0.7;

function render() {
  phraseEl.textContent = phrases[i] || "üéâ Done!";
  document.getElementById("current").textContent = i+1;
  document.getElementById("total").textContent = phrases.length;
  document.getElementById("correct").textContent = ok;
  document.getElementById("wrong").textContent = bad;
}
render();

// ================= GOOGLE FEMALE VOICE =================
function loadVoice(){
  const voices = speechSynthesis.getVoices();
  femaleVoice =
    voices.find(v=>v.name.includes("Google") && v.lang.includes("en")) ||
    voices.find(v=>v.lang.includes("en") && v.name.toLowerCase().includes("female")) ||
    voices.find(v=>v.lang.includes("en")) ||
    voices[0];
}
speechSynthesis.onvoiceschanged = loadVoice;

function speak(){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(phrases[i]);
  u.lang = "en-US";
  u.rate = 0.9;
  u.voice = femaleVoice;
  speechSynthesis.speak(u);
}

// ================= AUDIO UNLOCK =================
function unlockAudio() {
  okSound.play().then(()=>okSound.pause()).catch(()=>{});
  badSound.play().then(()=>badSound.pause()).catch(()=>{});
}

// ================= SPEECH =================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();
rec.lang = "en-US";
rec.continuous = false;

function normalize(t){
  return t.toLowerCase().replace(/[^\w\s]/g,"").trim();
}

function similarity(a,b){
  const aW = a.split(" ");
  const bW = b.split(" ");
  let m = 0;
  bW.forEach(w=>{ if(aW.includes(w)) m++; });
  return m / bW.length;
}

// ================= INIT =================
function initApp(){
  if(initialized) return;
  loadVoice();
  unlockAudio();
  rec.start();
  initialized = true;
}

// ================= RESULT =================
rec.onresult = e => {
  const spoken = normalize(e.results[0][0].transcript);
  const target = normalize(phrases[i]);

  if(similarity(spoken,target) >= 0.75){
    ok++;
    resultEl.innerHTML = `<div class="correct">‚úÖ CORRECT</div>`;

    okSound.currentTime = 0;
    okSound.play();

    setTimeout(()=>{
      i++;
      render();
      speak();
    },900);

  } else {
    bad++;
    resultEl.innerHTML = `<div class="wrong">‚ùå TRY AGAIN</div>`;

    badSound.currentTime = 0;
    badSound.play();
    if(navigator.vibrate) navigator.vibrate(120);

    render();
  }
};

// üîÅ otomatik devam
rec.onend = () => {
  if(initialized && i < phrases.length) rec.start();
};

// ================= CONTROLS =================
function skip(){ i++; render(); speak(); }
function back(){ if(i>0) i--; render(); speak(); }

</script>

</body>
</html>
