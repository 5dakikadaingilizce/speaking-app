<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>5 Dakikada ƒ∞ngilizce - Practice (Vers.1.3)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background:linear-gradient(135deg,#141e30,#243b55);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}
.app{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(15px);
  padding:35px;
  border-radius:20px;
  width:95%;
  max-width:600px;
  text-align:center;
  border: 1px solid rgba(255,255,255,0.15);
}
h2 {
  font-size: 24px;
  margin: 0;
  color: #fff;
}
.sub-title {
  font-size: 14px;
  color: #00c6ff;
  font-weight: bold;
  margin: 5px 0 25px 0;
  opacity: 0.9;
}
#phrase{
  font-size:32px;
  font-weight:700;
  margin:25px 0;
  color: #00ffb3;
  min-height: 40px;
}
button{
  padding:15px 25px;
  margin:8px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  font-weight: bold;
  transition: all 0.2s;
}
button:active { transform: scale(0.95); }
.start{background:#00c6ff; color:white; width: 80%;}
.ctrl{background:#334155; color:white;}
.next{background:#10b981; color:white; display:none;}
.correct{color:#10b981; font-size:24px; font-weight:bold; margin-top: 15px;}
.wrong{color:#ff6b6b; font-size:20px; font-weight:bold; margin-top: 15px;}
.stats{margin-top:30px; font-size:14px; opacity: 0.7; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;}
</style>
</head>

<body>

<div class="app">
  <h2>5 Dakikada ƒ∞ngilizce (Vers.1.3)</h2>
  <div class="sub-title">1. KUR SPEAKING PRACTICE</div>
  
  <div id="phrase">Loading...</div>

  <button class="start" id="startBtn">üé§ TAP TO SPEAK</button><br>
  <button class="ctrl" id="listenBtn">üîä Listen</button>
  <button class="ctrl" id="backBtn">‚¨Ö Back</button>
  <button class="next" id="nextBtn">Next Phrase ‚ñ∂</button>

  <div id="result"></div>

  <div class="stats">
    Progress: <span id="current"></span> / <span id="total"></span><br>
    ‚úÖ <span id="correct">0</span> | ‚ùå <span id="wrong">0</span>
  </div>
</div>

<audio id="okSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
<audio id="badSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>

<script>
/* VERSION: 1.3
   CHANGES: 
   - Revision number moved to main title.
   - Reduced pronunciation sensitivity (Fuzzy Matching).
   - Levinshtein Distance logic added for better user experience.
*/

// ================= GRAMMAR ENGINE =================
const prepositions = ["of","to","for","from","with","in","on","at"];
const determiners = [
  { type:"article", value:"a" },
  { type:"article", value:"an" },
  { type:"number", value:"two" },
  { type:"number", value:"three" },
  { type:"possessive", value:"my" }
];
const nouns = [
  { word:"child", plural:false, vowel:false },
  { word:"children", plural:true, vowel:false },
  { word:"apple", plural:false, vowel:true },
  { word:"apples", plural:true, vowel:true },
  { word:"car", plural:false, vowel:false },
  { word:"cars", plural:true, vowel:false }
];

function isValid(det, noun) {
  if (det.type === "article" && noun.plural) return false;
  if (det.value === "an" && !noun.vowel) return false;
  if (det.value === "a" && noun.vowel) return false;
  if (det.type === "number" && !noun.plural) return false;
  return true;
}

let phrases = [];
prepositions.forEach(p => {
  determiners.forEach(d => {
    nouns.forEach(n => {
      if(isValid(d, n)) phrases.push(`${p} ${d.value} ${n.word}`);
    });
  });
});

// ================= FUZZY MATCHING (ESNEK KAR≈ûILA≈ûTIRMA) =================
function getSimilarity(s1, s2) {
  let longer = s1.length < s2.length ? s2 : s1;
  let shorter = s1.length < s2.length ? s1 : s2;
  if (longer.length == 0) return 1.0;
  return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
}

function editDistance(s1, s2) {
  s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
  let costs = new Array();
  for (let i = 0; i <= s1.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else {
        if (j > 0) {
          let newValue = costs[j - 1];
          if (s1.charAt(i - 1) != s2.charAt(j - 1))
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
          costs[j - 1] = lastValue;
          lastValue = newValue;
        }
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

// ================= STATE =================
let index = 0;
let correctCount = 0;
let wrongCount = 0;
let solved = new Array(phrases.length).fill(false);

const phraseEl = document.getElementById("phrase");
const resultEl = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");
const okSound = document.getElementById("okSound");
const badSound = document.getElementById("badSound");

document.getElementById("total").textContent = phrases.length;

function render() {
  phraseEl.textContent = phrases[index];
  document.getElementById("current").textContent = index + 1;
  document.getElementById("correct").textContent = correctCount;
  document.getElementById("wrong").textContent = wrongCount;
  nextBtn.style.display = solved[index] ? "inline-block" : "none";
}
render();

function speak() {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(phrases[index]);
  u.lang = "en-US";
  u.rate = 1.0; 
  window.speechSynthesis.speak(u);
}

// ================= RECOGNITION =================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();
rec.lang = "en-US";

rec.onstart = () => {
    document.getElementById("startBtn").innerText = "Listening...";
    document.getElementById("startBtn").style.background = "#ff4b2b";
};

rec.onresult = e => {
  const spoken = e.results[0][0].transcript.toLowerCase().trim();
  const target = phrases[index].toLowerCase().trim();

  // Hassasiyeti burada ayarlƒ±yoruz: %75 benzerlik yeterli
  const similarity = getSimilarity(spoken, target);

  if(spoken === target || similarity > 0.75) {
    if(!solved[index]) { solved[index] = true; correctCount++; }
    resultEl.innerHTML = '<div class="correct">‚úÖ WELL DONE!</div>';
    okSound.play().catch(() => {}); 
  } else {
    wrongCount++;
    resultEl.innerHTML = `<div class="wrong">‚ùå You said: "${spoken}"</div>`;
    badSound.play().catch(() => {});
  }
  render();
};

rec.onend = () => {
    document.getElementById("startBtn").innerText = "üé§ TAP TO SPEAK";
    document.getElementById("startBtn").style.background = "#00c6ff";
};

// ================= BUTTON ACTIONS =================
document.getElementById("startBtn").onclick = () => {
    okSound.play().then(() => { okSound.pause(); okSound.currentTime = 0; }).catch(() => {});
    rec.start();
};
document.getElementById("listenBtn").onclick = speak;
document.getElementById("nextBtn").onclick = () => {
    if(index < phrases.length - 1) { index++; resultEl.innerHTML = ""; render(); speak(); }
};
document.getElementById("backBtn").onclick = () => {
    if(index > 0) { index--; resultEl.innerHTML = ""; render(); speak(); }
};
</script>

</body>
</html>
