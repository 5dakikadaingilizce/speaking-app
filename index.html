<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grammar-Aware Speaking Drill (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}
.app{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(15px);
  padding:40px;
  border-radius:24px;
  width:90%;
  max-width:600px;
  text-align:center;
  border: 1px solid rgba(255,255,255,0.1);
}
#phrase{
  font-size:32px;
  font-weight:700;
  margin:30px 0;
  color: #38bdf8;
  min-height: 40px;
}
button{
  padding:14px 24px;
  margin:8px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  font-weight: 600;
  transition: all 0.2s;
}
.start{background:#0ea5e9;color:white;}
.start:active{transform: scale(0.95);}
.ctrl{background:#334155;color:white;}
.next{background:#10b981;color:white; display:none;}
.correct{color:#10b981; font-size:24px; font-weight: bold; margin-top: 10px;}
.wrong{color:#f43f5e; font-size:24px; font-weight: bold; margin-top: 10px;}
.stats{margin-top:25px; font-size:14px; color: #94a3b8; border-top: 1px solid #334155; padding-top: 15px;}
</style>
</head>

<body>

<div class="app">
<h2>üé§ Speaking Drill</h2>

<div id="phrase">Y√ºkleniyor...</div>

<button class="start" id="startBtn">üé§ TAP TO SPEAK</button><br>
<button class="ctrl" id="listenBtn">üîä Listen Word</button>
<button class="ctrl" id="backBtn">‚¨Ö Back</button>
<button class="next" id="nextBtn">Next Phrase ‚ñ∂</button>

<div id="result"></div>

<div class="stats">
Phrase <span id="current">1</span>/<span id="total">0</span><br>
‚úÖ <span id="correct">0</span> | ‚ùå <span id="wrong">0</span>
</div>
</div>

<script>
// ================= GRAMMAR CONFIG =================
const prepositions = ["of","to","for","from","with","in","on","at"];

const determiners = [
  { type:"article", value:"a" },
  { type:"article", value:"an" },
  { type:"number", value:"two" },
  { type:"number", value:"three" },
  { type:"possessive", value:"my" },
  { type:"possessive", value:"your" }
];

const nouns = [
  { word:"child", plural:false },
  { word:"children", plural:true },
  { word:"apple", plural:false, startsWithVowel: true },
  { word:"apples", plural:true, startsWithVowel: true },
  { word:"car", plural:false },
  { word:"cars", plural:true }
];

// ================= GRAMMAR ENGINE (FIXED) =================
function isValid(det, noun) {
  // 1. √áoƒüul isimlerle "a/an" asla gelmez
  if(det.type === "article" && noun.plural) return false;
  
  // 2. "An" sadece sesli harfle ba≈ülayan tekil isimle gelir
  if(det.value === "an" && !noun.startsWithVowel) return false;
  
  // 3. "A" sesli harfle ba≈ülayanla gelmez
  if(det.value === "a" && noun.startsWithVowel) return false;

  // 4. Sayƒ±lar (two, three) sadece √ßoƒüul isimlerle gelir
  if(det.type === "number" && !noun.plural) return false;

  return true;
}

// ================= BUILD PHRASES =================
let phrases = [];
prepositions.forEach(p => {
  determiners.forEach(d => {
    nouns.forEach(n => {
      if(isValid(d, n)) {
        phrases.push(`${p} ${d.value} ${n.word}`);
      }
    });
  });
});

// ================= STATE & LOGIC =================
let index = 0;
let correctCount = 0;
let wrongCount = 0;
let solved = new Array(phrases.length).fill(false);

const phraseEl = document.getElementById("phrase");
const resultEl = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");

document.getElementById("total").textContent = phrases.length;

function render() {
  phraseEl.textContent = phrases[index];
  document.getElementById("current").textContent = index + 1;
  document.getElementById("correct").textContent = correctCount;
  document.getElementById("wrong").textContent = wrongCount;
  nextBtn.style.display = solved[index] ? "inline-block" : "none";
}

// ================= SOUND EFFECTS (SYSTEM GENERATED) =================
function playSound(type) {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  if(type === 'ok') {
    osc.frequency.setValueAtTime(500, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
  } else {
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
  }
  osc.start();
  osc.stop(ctx.currentTime + 0.3);
}

// ================= SPEECH (LISTEN) =================
function speak() {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(phrases[index]);
  u.lang = "en-US";
  u.rate = 0.8;
  window.speechSynthesis.speak(u);
}

// ================= RECOGNITION (FIXED) =================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();
rec.lang = "en-US";
rec.interimResults = false;

rec.onstart = () => {
    document.getElementById("startBtn").innerText = "Listening...";
    document.getElementById("startBtn").style.background = "#ef4444";
};

rec.onresult = e => {
  const spoken = e.results[0][0].transcript.toLowerCase().replace(/[^\w\s]/g,"").trim();
  const target = phrases[index].toLowerCase().trim();

  if(spoken === target) {
    if(!solved[index]) {
      solved[index] = true;
      correctCount++;
    }
    resultEl.innerHTML = '<div class="correct">‚úÖ PERFECT!</div>';
    playSound('ok');
  } else {
    wrongCount++;
    resultEl.innerHTML = `<div class="wrong">‚ùå You said: "${spoken}"</div>`;
    playSound('bad');
  }
  render();
};

rec.onend = () => {
    document.getElementById("startBtn").innerText = "üé§ TAP TO SPEAK";
    document.getElementById("startBtn").style.background = "#0ea5e9";
};

// ================= NAVIGATION =================
document.getElementById("startBtn").onclick = () => rec.start();
document.getElementById("listenBtn").onclick = speak;
document.getElementById("nextBtn").onclick = () => {
  if(index < phrases.length - 1) {
    index++;
    resultEl.innerHTML = "";
    render();
  }
};
document.getElementById("backBtn").onclick = () => {
  if(index > 0) {
    index--;
    resultEl.innerHTML = "";
    render();
  }
};

render();
</script>

</body>
</html>
